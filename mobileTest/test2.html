<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>D3 Mobile Testing</title>
  <meta charset="utf-8" />
</head>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/colorbrewer.v1.min.js"></script>
<style>
  body, html {
    width:100%;
    height:100%;
  }
  #vizcontainer {
    width:100%;
    height:100%;
  }
  svg {
    width: 100%;
    height: 100%;
  }
  #buttons {
    width: 100%;
    height: 100%;
    position: fixed;
    z-index: 1;
    top: 0;
  }
  button {
    width: 100%;
    height: 15%;
  }
</style>
<body>

<div id="vizcontainer">
<svg></svg>
<div id="buttons">
  <button onclick="touchDemo7();">All Three</button>
  <button onclick="touchDemo8();">Nested G Elements</button>
</div>
</div>
  <footer>
<script>
  function touchDemo7() {
    var initialD = [];
    var initialTransform;

    d3.select("#buttons").html("").style("pointer-events", "none").append("div").attr("id", "touchStatus").append("p").html("Touch Status:").append("ol");

    d3.select("svg").on("touchstart", touchBegin);
    d3.select("svg").on("touchend", touchBegin);
    d3.select("svg").on("touchmove", touchUpdate);

    var touchColor = d3.scale.linear().domain([0, 10]).range(["pink", "darkred"])

    var graphicsG = d3.select("svg").append("g").attr("id", "graphics").attr("transform", "rotate(0)");

  sampleData = d3.range(10).map(function(d) {
    var datapoint = {};
    datapoint.id = "Sample " + d;
    datapoint.x = Math.random() * 500;
    datapoint.y = Math.random() * 500;
    return datapoint;
  })
     
     var samples = graphicsG.selectAll("g")
     .data(sampleData)
     .enter()
     .append("g")
     .attr("transform", function(d) {return "translate("+d.x+","+d.y+")"});
     
     var sampleSubG = samples.append("g").attr("class", "sample");
     sampleSubG.append("rect").attr("width", 100).attr("height", 100)
     .style("fill", "red").style("stroke", "gray").style("stroke-width", "1px");

     sampleSubG.append("text").text(function (d) {return d.id}).attr("y", 20);

    function touchBegin() {
      d3.event.preventDefault();
      d3.event.stopPropagation();
       
      d = d3.touches(this);
      initialD = d;
      initialTransform = d3.transform(d3.select("#graphics").attr("transform"));

          }
     function touchUpdate() {
       d3.event.preventDefault();
       d3.event.stopPropagation();
       d = d3.touches(this);
       d3.select("svg").selectAll("circle.fingertips").data(d).enter().append("circle")
       .attr("class", "fingertips").attr("r", 75).style("fill", function(d, i) {
         return touchColor(i)
       });

       d3.select("svg").selectAll("circle.fingertips").data(d).exit().remove();

       d3.select("svg").selectAll("circle.fingertips").attr("cx", function(d) {
         return d[0]
       }).attr("cy", function(d) {
         return d[1]
       });
       
        var newX = initialTransform.translate[0];
        var newY = initialTransform.translate[1];
        var newRotate = initialTransform.rotate;
        var newScale = initialTransform.scale[0];

                      d3.select("#touchStatus").html("")

      if (d.length == 1) {
        newX = initialD[0][0] - d[0][0] - initialTransform.translate[0];
        newY = initialD[0][1] - d[0][1] - initialTransform.translate[1];
      }
      else if (d.length == 2) {
        var initialLength = Math.sqrt(Math.abs(initialD[0][0] - initialD[1][0]) + Math.abs(initialD[0][1] - initialD[1][1]));
        var currentLength = Math.sqrt(Math.abs(d[0][0] - d[1][0]) + Math.abs(d[0][1] - d[1][1]));
        var zoom = currentLength / initialLength;
        newScale = zoom * initialTransform.scale[0];
        d3.select("#touchStatus").append("p").html("Initial Scale: " + initialScale);
        d3.select("#touchStatus").append("p").html("Initial Length: " + initialLength);
        d3.select("#touchStatus").append("p").html("Current Length: " + currentLength);

      }
      else if (d.length == 3) {
        var slope1 = (initialD[0][1] - initialD[1][1]) / (initialD[0][0] - initialD[1][0]);
        var slope2 = (d[0][1] - d[1][1]) / (d[0][0] - d[1][0]);
        
        var angle = Math.atan((slope1 - slope2)/(1 + slope1*slope2)) * 180/Math.PI;
        var newRotate = initialTransform.rotate - angle;

        d3.selectAll("g.sample > text").attr("transform", "rotate(" +(-newRotate)+")")

      }

        d3.select("#touchStatus").append("p").html("Zoom: " + zoom);
        d3.select("#touchStatus").append("p").html("New Scale: " + newScale);
      
      d3.select("#graphics").attr("transform", "translate(" +(-newX) +"," + (-newY) + ") scale("+newScale+") rotate(" + newRotate + ")")

     }

  }

    function touchDemo8() {
    var initialD = [];
    var initialTransform;

    d3.select("#buttons").html("").style("pointer-events", "none").append("div").attr("id", "touchStatus").append("p").html("Touch Status:").append("ol");

    d3.select("svg").on("touchstart", touchBegin);
    d3.select("svg").on("touchend", touchBegin);
    d3.select("svg").on("touchmove", touchUpdate);

    var touchColor = d3.scale.linear().domain([0, 10]).range(["blue", "darkred"])

    var graphicsG = d3.select("svg").append("g").attr("id", "pan").append("g").attr("id", "zoom").append("g").attr("id", "rotate").attr("transform", "rotate(0)");

  sampleData = d3.range(10).map(function(d) {
    var datapoint = {};
    datapoint.id = "Sample " + d;
    datapoint.x = Math.random() * 500;
    datapoint.y = Math.random() * 500;
    return datapoint;
  })
     
     var samples = graphicsG.selectAll("g")
     .data(sampleData)
     .enter()
     .append("g")
     .attr("transform", function(d) {return "translate("+d.x+","+d.y+")"});
     
     var sampleSubG = samples.append("g").attr("class", "sample");
     sampleSubG.append("rect").attr("width", 100).attr("height", 100)
     .style("fill", "red").style("stroke", "gray").style("stroke-width", "1px");

     sampleSubG.append("text").text(function (d) {return d.id}).attr("y", 20);

    function touchBegin() {
      d3.event.preventDefault();
      d3.event.stopPropagation();
       
      d = d3.touches(this);
      initialD = d;
      initialTransform = d3.transform(d3.select("#graphics").attr("transform"));

          }
     function touchUpdate() {
       d3.event.preventDefault();
       d3.event.stopPropagation();
       d = d3.touches(this);
             d3.select("#touchStatus").selectAll("p").remove();
        d3.select("#touchStatus").append("p").html(d);

       d3.select("svg").selectAll("circle.fingertips").data(d).enter().append("circle")
       .attr("class", "fingertips").attr("r", 75).style("fill", function(d, i) {
         return touchColor(i)
       });

       d3.select("svg").selectAll("circle.fingertips").data(d).exit().remove();

       d3.select("svg").selectAll("circle.fingertips").attr("cx", function(d) {
         return d[0]
       }).attr("cy", function(d) {
         return d[1]
       });
       
        var newX = initialTransform.translate[0];
        var newY = initialTransform.translate[1];
        var newRotate = initialTransform.rotate;
        var newScale = initialTransform.scale[0];

      if (d.length == 1) {
        newX = initialD[0][0] - d[0][0] - initialTransform.translate[0];
        newY = initialD[0][1] - d[0][1] - initialTransform.translate[1];
        d3.select("#touchStatus").append("p").html("One Finger");
      }
      else if (d.length == 2) {
        var initialLength = Math.sqrt(Math.abs(initialD[0][0] - initialD[1][0]) + Math.abs(initialD[0][1] - initialD[1][1]));
        var currentLength = Math.sqrt(Math.abs(d[0][0] - d[1][0]) + Math.abs(d[0][1] - d[1][1]));
        var zoom = currentLength / initialLength;
        newScale = zoom * initialTransform.scale[0];
        d3.select("#touchStatus").append("p").html("Two Fingers");
        d3.select("#touchStatus").append("p").html("Initial Scale: " + initialScale);
        d3.select("#touchStatus").append("p").html("Initial Length: " + initialLength);
        d3.select("#touchStatus").append("p").html("Current Length: " + currentLength);

      }
      else if (d.length == 3) {
        var slope1 = (initialD[0][1] - initialD[1][1]) / (initialD[0][0] - initialD[1][0]);
        var slope2 = (d[0][1] - d[1][1]) / (d[0][0] - d[1][0]);
        
        var angle = Math.atan((slope1 - slope2)/(1 + slope1*slope2)) * 180/Math.PI;
        var newRotate = initialTransform.rotate - angle;

        d3.selectAll("g.sample > text").attr("transform", "rotate(" +(-newRotate)+")")
        d3.select("#touchStatus").append("p").html("Three Fingers");

      }

        d3.select("#touchStatus").append("p").html("Zoom: " + zoom);
        d3.select("#touchStatus").append("p").html("New Scale: " + newScale);
        d3.select("#touchStatus").append("p").html("New Rotate: " + newRotate);
      
      d3.select("#pan").attr("transform", "translate(" +(-newX) +"," + (-newY) + ")")
      d3.select("#zoom").attr("transform", "scale("+newScale + ")")
      d3.select("#rotate").attr("transform", "rotate(" + newRotate + ")")

     }

  }
</script>
  </footer>
</body>
</html>